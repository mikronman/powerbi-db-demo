name: Azure SQL â€“ Drop

on:
  workflow_dispatch:

jobs:
  drop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sqlcmd (ODBC + tools)
        run: |
          sudo ACCEPT_EULA=Y apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          echo '/opt/mssql-tools18/bin' >> $GITHUB_PATH

      - name: Verify sqlcmd
        run: sqlcmd -?

      - name: Build CI-safe drop script (normalize :r, strip CRLF, drop TRY/CATCH/TRAN)
        working-directory: db/scripts
        run: |
          awk '{
            line=$0
            sub(/\r$/, "", line)
            if (line ~ /^[[:space:]]*:r[[:space:]]+/) gsub("\\\\","/",line)
            if (line ~ /^[[:space:]]*BEGIN[[:space:]]+TRY\b/i) next
            if (line ~ /^[[:space:]]*END[[:space:]]+TRY\b/i) next
            if (line ~ /^[[:space:]]*BEGIN[[:space:]]+CATCH\b/i) next
            if (line ~ /^[[:space:]]*END[[:space:]]+CATCH\b/i) next
            if (line ~ /^[[:space:]]*BEGIN[[:space:]]+TRAN\b/i) next
            if (line ~ /^[[:space:]]*COMMIT[[:space:]]+TRAN\b/i) next
            if (line ~ /^[[:space:]]*ROLLBACK[[:space:]]+TRAN\b/i) next
            if (line ~ /^[[:space:]]*THROW\b/i) next
            print line
          }' drop_all.sql > drop_all.ci.sql

          echo "==== First 30 lines (sanity) ===="
          nl -ba drop_all.ci.sql | sed -n '1,30p'
          echo "==== Include lines (post-normalization) ===="
          grep -nE '^[[:space:]]*:r[[:space:]]+' drop_all.ci.sql || true

      - name: Run drop_all.ci.sql
        working-directory: db/scripts
        env:
          SQLCMDPASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
        run: |
          sqlcmd -C -b -I \
            -S "${{ secrets.AZURE_SQL_SERVER }}" \
            -U "${{ secrets.AZURE_SQL_USER }}" \
            -v DBName="${{ secrets.AZURE_SQL_DB }}" \
            -i "./drop_all.ci.sql"
